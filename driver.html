<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zayra Partner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background: #111; color: white; overflow: hidden; }
        
        /* Dashboard Animation */
        .radar-scan {
            width: 150px; height: 150px; border-radius: 50%; border: 2px solid #22c55e;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 50px rgba(34, 197, 94, 0.2);
        }
        .radar-scan::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(transparent, rgba(34, 197, 94, 0.4));
            animation: radar 2s linear infinite;
        }
        @keyframes radar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Request Modal */
        .modal {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; color: black;
            border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 30px;
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50; box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }
        .modal.active { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="ui-login" class="fixed inset-0 bg-yellow-400 flex flex-col justify-center p-8 z-[100]">
        <h1 class="text-5xl font-black mb-2 tracking-tighter">PARTNER</h1>
        <p class="font-bold text-lg opacity-60 mb-8">Driver App v4.0</p>
        
        <div class="bg-white p-6 rounded-3xl shadow-2xl space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">Driver ID (From QR)</label>
                <input type="text" id="login-id" class="w-full bg-gray-100 p-4 rounded-xl font-bold text-xl uppercase outline-none border-2 focus:border-black" placeholder="RAJU01">
            </div>
            <button onclick="login()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-xl shadow-lg">Login</button>
        </div>
    </div>

    <div id="ui-dash" class="hidden h-screen w-full relative">
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-10">
            <div class="bg-gray-800/80 backdrop-blur p-4 rounded-2xl border border-gray-700">
                <div class="text-xs text-gray-400 font-bold uppercase">Today's Earnings</div>
                <div class="text-3xl font-bold text-green-400">₹850</div>
            </div>
            
            <button id="btn-toggle" onclick="toggleOnline()" class="bg-red-500 text-white px-6 py-3 rounded-full font-bold shadow-lg transition-colors">
                GO ONLINE
            </button>
        </div>

        <div id="radar-ui" class="hidden h-full w-full relative">
            <div class="radar-scan"></div>
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center">
                <i class="ri-taxi-wifi-line text-4xl text-green-500"></i>
                <div class="mt-4 font-bold text-green-500 animate-pulse">Scanning for Rides...</div>
            </div>
        </div>

        <div id="offline-ui" class="h-full flex flex-col items-center justify-center text-center opacity-50">
            <i class="ri-moon-clear-line text-6xl mb-4"></i>
            <h2 class="text-2xl font-bold">You are Offline</h2>
            <p>Go Online to receive trips.</p>
        </div>
    </div>

    <div id="ui-request" class="modal">
        <div class="flex justify-between items-start mb-2">
            <div class="bg-green-100 text-green-800 px-3 py-1 rounded-lg text-xs font-bold uppercase">New Request</div>
            <div class="text-xs font-bold text-gray-500">800m away</div>
        </div>
        <div class="text-5xl font-black mb-6">₹<span id="req-fare">0</span></div>

        <div class="space-y-4 mb-8">
            <div class="flex gap-4">
                <i class="ri-map-pin-user-fill text-xl text-green-600"></i>
                <div>
                    <div class="text-[10px] font-bold text-gray-400 uppercase">Pickup</div>
                    <div class="font-bold text-lg leading-none">Passenger Location</div>
                </div>
            </div>
            <div class="flex gap-4">
                <i class="ri-map-pin-fill text-xl text-red-600"></i>
                <div>
                    <div class="text-[10px] font-bold text-gray-400 uppercase">Drop</div>
                    <div class="font-bold text-lg leading-none">Drop Location Selected</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="ignoreRide()" class="bg-gray-100 py-4 rounded-xl font-bold text-gray-500">Skip</button>
            <button onclick="acceptRide()" class="bg-green-500 text-white py-4 rounded-xl font-bold text-xl shadow-xl">ACCEPT</button>
        </div>
        <audio id="sfx-ring" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>
    </div>

    <div id="ui-active" class="fixed inset-0 bg-white text-black z-[200] hidden flex flex-col">
        <div class="h-1/2 bg-gray-100 relative flex items-center justify-center">
            <p class="text-gray-400 font-bold">Map Navigation View</p>
            <button onclick="openMaps()" class="absolute bottom-6 right-6 bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-xl flex items-center gap-2">
                <i class="ri-navigation-fill"></i> NAVIGATE
            </button>
        </div>
        
        <div class="h-1/2 bg-white rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] -mt-6 relative p-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold">Passenger Name</h2>
                    <p class="text-green-600 font-bold text-sm">● On Trip</p>
                </div>
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-xl"><i class="ri-phone-fill"></i></div>
            </div>

            <div id="otp-box">
                <label class="text-xs font-bold text-gray-400 uppercase">Ask OTP from Passenger</label>
                <div class="flex gap-2 mt-2">
                    <input type="tel" id="otp-in" class="w-full bg-gray-100 p-4 rounded-xl font-bold text-2xl tracking-[10px] text-center outline-none border-2 focus:border-black" placeholder="0000" maxlength="4">
                    <button onclick="verifyOtp()" class="bg-black text-white px-6 rounded-xl font-bold">GO</button>
                </div>
            </div>

            <button id="btn-end" class="hidden w-full bg-red-500 text-white py-4 rounded-xl font-bold text-xl shadow-lg mt-auto" onclick="endRide()">COMPLETE RIDE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAMshTP9HgrB27FuLNP4CZN6VJKPDW8CQ",
            authDomain: "zayra-travels.firebaseapp.com",
            databaseURL: "https://zayra-travels-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "zayra-travels",
            storageBucket: "zayra-travels.firebasestorage.app",
            messagingSenderId: "124448306082",
            appId: "1:124448306082:web:cf5943d8592bc68b9c38fb"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let driverId = null;
        let isOnline = false;
        let currentRideKey = null;
        let currentRideData = null;

        // LOGIN
        window.login = () => {
            const val = document.getElementById('login-id').value.trim();
            if(!val) return alert("Enter ID");
            driverId = val;
            document.getElementById('ui-login').classList.add('hidden');
            document.getElementById('ui-dash').classList.remove('hidden');
            
            // Register Driver Status
            update(ref(db, 'drivers/'+driverId), { status: 'offline', last_seen: Date.now() });
            
            startListener();
        };

        // ONLINE TOGGLE
        window.toggleOnline = () => {
            isOnline = !isOnline;
            const btn = document.getElementById('btn-toggle');
            if(isOnline) {
                btn.innerText = "GO OFFLINE";
                btn.className = "bg-white text-black px-6 py-3 rounded-full font-bold shadow-lg";
                document.getElementById('radar-ui').classList.remove('hidden');
                document.getElementById('offline-ui').classList.add('hidden');
                update(ref(db, 'drivers/'+driverId), { status: 'online' });
            } else {
                btn.innerText = "GO ONLINE";
                btn.className = "bg-red-500 text-white px-6 py-3 rounded-full font-bold shadow-lg";
                document.getElementById('radar-ui').classList.add('hidden');
                document.getElementById('offline-ui').classList.remove('hidden');
                update(ref(db, 'drivers/'+driverId), { status: 'offline' });
            }
        };

        // LISTEN FOR RIDES
        function startListener() {
            onChildAdded(ref(db, 'rides'), (snap) => {
                const ride = snap.val();
                if(!isOnline) return;
                
                // Match Logic: Broadcast OR Specific Driver ID
                if(ride.status === 'pending' && (ride.driverId === 'broadcast' || ride.driverId === driverId)) {
                    showRequest(ride, snap.key);
                }
            });
        }

        function showRequest(ride, key) {
            currentRideKey = key;
            currentRideData = ride;
            
            document.getElementById('req-fare').innerText = ride.fare;
            document.getElementById('ui-request').classList.add('active');
            document.getElementById('sfx-ring').play();
        }

        window.ignoreRide = () => {
            document.getElementById('ui-request').classList.remove('active');
            document.getElementById('sfx-ring').pause();
        };

        window.acceptRide = () => {
            document.getElementById('sfx-ring').pause();
            
            // Update Firebase
            update(ref(db, 'rides/'+currentRideKey), {
                status: 'accepted',
                driverName: 'Raju Driver', // Replace with dynamic name
                driverPlate: 'DL 1R 5555'
            });

            document.getElementById('ui-request').classList.remove('active');
            document.getElementById('ui-dash').classList.add('hidden');
            document.getElementById('ui-active').classList.remove('hidden');
        };

        // ACTIVE RIDE FUNCTIONS
        window.openMaps = () => {
            const lat = currentRideData.drop.lat;
            const lng = currentRideData.drop.lng;
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        };

        window.verifyOtp = () => {
            const input = document.getElementById('otp-in').value;
            if(parseInt(input) === currentRideData.otp) {
                alert("OTP Matched! Ride Started.");
                document.getElementById('otp-box').classList.add('hidden');
                document.getElementById('btn-end').classList.remove('hidden');
            } else {
                alert("Incorrect OTP");
            }
        };

        window.endRide = () => {
            update(ref(db, 'rides/'+currentRideKey), { status: 'completed' });
            alert("Ride Finished! Cash Collected: ₹" + currentRideData.fare);
            location.reload();
        };

    </script>
</body>
</html>
