<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zayra Partner - Driver App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; overflow: hidden; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        /* Map behind dashboard */
        #map-bg { position: absolute; top: 0; left: 0; width: 100%; height: 60%; opacity: 0.3; z-index: 0; pointer-events: none; }

        /* Request Modal Animation */
        .request-popup {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; color: black; border-top-left-radius: 24px; border-top-right-radius: 24px;
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
            z-index: 5000; padding: 24px; box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .request-popup.active { transform: translateY(0); }

        /* Pulsing Online Indicator */
        .pulse-online {
            width: 15px; height: 15px; background: #48bb78; border-radius: 50%;
            box-shadow: 0 0 0 rgba(72, 187, 120, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="login-ui" class="fixed inset-0 bg-yellow-400 z-[6000] flex flex-col justify-center p-6 text-black">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-extrabold mb-2">Zayra Partner</h1>
            <p class="font-bold opacity-70">Earn more with every ride</p>
        </div>
        
        <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Driver ID (From QR)</label>
                <input type="text" id="d-id" class="w-full bg-gray-100 p-4 rounded-xl font-bold text-lg outline-none border-2 focus:border-black" placeholder="e.g. driver_123">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Vehicle Number</label>
                <input type="text" id="d-plate" class="w-full bg-gray-100 p-4 rounded-xl font-bold text-lg outline-none border-2 focus:border-black" placeholder="DL 1R 5555">
            </div>
            <button onclick="driverLogin()" class="w-full bg-black text-white p-4 rounded-xl font-bold text-lg shadow-lg mt-4">Login to Dashboard</button>
        </div>
        <p class="text-center mt-6 text-sm font-bold opacity-60">Make sure ID matches your QR Sticker</p>
    </div>

    <div id="dashboard-ui" class="hidden relative h-screen flex flex-col">
        <div id="map-bg"></div>

        <div class="relative z-10 p-6 flex justify-between items-start">
            <div class="bg-black/80 backdrop-blur p-4 rounded-2xl border border-gray-700">
                <h2 class="text-gray-400 text-xs font-bold uppercase">Total Earnings</h2>
                <div class="text-3xl font-bold text-yellow-400">₹<span id="earnings">850</span></div>
            </div>
            
            <div class="flex items-center gap-3 bg-white p-2 pr-4 rounded-full shadow-lg">
                <div id="status-indicator" class="w-3 h-3 bg-red-500 rounded-full"></div>
                <label class="font-bold text-black text-sm" id="status-text">OFFLINE</label>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="online-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0 transition-all duration-300" onclick="toggleOnline()"/>
                    <label for="toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
            </div>
        </div>

        <div id="waiting-anim" class="hidden flex-1 flex flex-col items-center justify-center relative z-10 mt-20">
            <div class="relative">
                <div class="absolute inset-0 bg-yellow-400 rounded-full opacity-20 animate-ping"></div>
                <div class="relative bg-black border-4 border-yellow-400 w-32 h-32 rounded-full flex items-center justify-center shadow-[0_0_50px_rgba(250,204,21,0.3)]">
                    <i class="ri-radar-line text-5xl text-yellow-400"></i>
                </div>
            </div>
            <h3 class="mt-8 text-xl font-bold">Finding Trips...</h3>
            <p class="text-gray-400 text-sm">You are visible to passengers</p>
        </div>
    </div>

    <div id="request-ui" class="request-popup">
        <div class="flex justify-between items-start mb-4">
            <div class="bg-green-100 text-green-800 px-3 py-1 rounded-lg text-xs font-bold">New Request</div>
            <div class="text-xs text-gray-500 font-bold">400m away</div>
        </div>
        
        <h1 class="text-4xl font-extrabold mb-1">₹<span id="req-fare">0</span></h1>
        <p class="text-sm text-gray-500 font-bold mb-6">Includes Priority Fee</p>

        <div class="space-y-6 relative">
            <div class="absolute left-[7px] top-2 bottom-6 w-0.5 bg-gray-200 border-l border-dashed"></div>

            <div class="flex gap-4">
                <div class="w-4 h-4 rounded-full bg-green-500 flex-shrink-0 mt-1"></div>
                <div>
                    <h3 class="font-bold text-lg leading-none mb-1">Pickup</h3>
                    <p class="text-gray-500 text-sm leading-tight" id="req-pickup">Detecting...</p>
                </div>
            </div>

            <div class="flex gap-4">
                <div class="w-4 h-4 rounded-full bg-red-500 flex-shrink-0 mt-1"></div>
                <div>
                    <h3 class="font-bold text-lg leading-none mb-1">Drop</h3>
                    <p class="text-gray-500 text-sm leading-tight" id="req-drop">Detecting...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-8">
            <button onclick="rejectRide()" class="py-4 rounded-xl font-bold text-gray-500 bg-gray-100">Ignore</button>
            <button onclick="acceptRide()" class="py-4 rounded-xl font-bold text-black bg-yellow-400 shadow-lg text-xl">Accept</button>
        </div>
        
        <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>
    </div>

    <div id="active-ride-ui" class="fixed inset-0 bg-white z-[4000] hidden flex flex-col text-black">
        <div id="ride-map" class="h-1/2 bg-gray-100 w-full relative">
            <button onclick="openGoogleMaps()" class="absolute bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 z-[1000]">
                <i class="ri-navigation-fill"></i> Navigate
            </button>
        </div>

        <div class="h-1/2 bg-white rounded-t-3xl shadow-[0_-5px_30px_rgba(0,0,0,0.1)] -mt-6 relative z-10 p-6 flex flex-col">
            
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold" id="p-name">Passenger Name</h2>
                    <p class="text-gray-500 text-sm">Payment: Cash</p>
                </div>
                <div class="bg-gray-100 p-3 rounded-full">
                    <i class="ri-phone-fill text-xl text-green-600"></i>
                </div>
            </div>

            <div id="otp-section">
                <label class="text-xs font-bold text-gray-400 uppercase">Enter OTP to Start</label>
                <div class="flex gap-2 mt-2">
                    <input type="tel" id="otp-input" class="w-full bg-gray-100 p-4 rounded-xl text-center text-2xl font-bold tracking-widest outline-none border-2 focus:border-black" placeholder="----" maxlength="4">
                    <button onclick="verifyOTP()" class="bg-black text-white px-6 rounded-xl font-bold">GO</button>
                </div>
            </div>

            <div id="end-ride-section" class="hidden mt-auto">
                <div class="bg-green-50 border border-green-200 p-4 rounded-xl mb-4 text-center">
                    <p class="text-green-800 font-bold">Ride in Progress...</p>
                </div>
                <button onclick="completeRide()" class="w-full bg-red-500 text-white py-4 rounded-xl font-bold text-xl shadow-lg">Complete Ride & Collect Cash</button>
            </div>
            
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAAMshTP9HgrB27FuLNP4CZN6VJKPDW8CQ",
            authDomain: "zayra-travels.firebaseapp.com",
            databaseURL: "https://zayra-travels-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "zayra-travels",
            storageBucket: "zayra-travels.firebasestorage.app",
            messagingSenderId: "124448306082",
            appId: "1:124448306082:web:cf5943d8592bc68b9c38fb"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // GLOBAL STATE
        let driverData = JSON.parse(localStorage.getItem('zayraDriver')) || null;
        let isOnline = false;
        let currentRideRef = null;
        let currentRideData = null;
        let map;

        // 1. INIT
        window.onload = () => {
            if(!driverData) {
                document.getElementById('login-ui').classList.remove('hidden');
            } else {
                showDashboard();
            }
            initMap();
        };

        function initMap() {
            // Leaflet Map for Background
            map = L.map('map-bg', { zoomControl: false, attributionControl: false }).setView([28.61, 77.20], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        // 2. LOGIN
        window.driverLogin = () => {
            const id = document.getElementById('d-id').value;
            const plate = document.getElementById('d-plate').value;
            
            if(!id || !plate) return alert("Please fill all details");
            
            driverData = { id: id.trim(), plate: plate, name: "Driver " + id.substr(-3) };
            localStorage.setItem('zayraDriver', JSON.stringify(driverData));
            
            // Save to Firebase Drivers list
            update(ref(db, 'drivers/' + driverData.id), {
                ...driverData,
                status: 'offline',
                last_seen: Date.now()
            });

            document.getElementById('login-ui').classList.add('hidden');
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('dashboard-ui').classList.remove('hidden');
            listenForRequests();
        }

        // 3. ONLINE/OFFLINE
        window.toggleOnline = () => {
            const checkbox = document.getElementById('online-toggle');
            isOnline = checkbox.checked;
            
            const indicator = document.getElementById('status-indicator');
            const label = document.getElementById('status-text');
            const anim = document.getElementById('waiting-anim');

            if(isOnline) {
                indicator.classList.remove('bg-red-500');
                indicator.classList.add('pulse-online');
                label.innerText = "ONLINE";
                anim.classList.remove('hidden');
                
                // Update Firebase
                update(ref(db, 'drivers/' + driverData.id), { status: 'online' });
                
                // Start GPS Watch
                if(navigator.geolocation) {
                    navigator.geolocation.watchPosition(pos => {
                        update(ref(db, 'drivers/' + driverData.id), {
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude
                        });
                        map.setView([pos.coords.latitude, pos.coords.longitude], 15);
                    });
                }

            } else {
                indicator.classList.add('bg-red-500');
                indicator.classList.remove('pulse-online');
                label.innerText = "OFFLINE";
                anim.classList.add('hidden');
                update(ref(db, 'drivers/' + driverData.id), { status: 'offline' });
            }
        }

        // 4. LISTEN FOR REQUESTS (The Business Logic)
        function listenForRequests() {
            const ridesRef = ref(db, 'rides');
            
            onChildAdded(ridesRef, (snapshot) => {
                if(!isOnline) return;
                
                const ride = snapshot.val();
                const rideKey = snapshot.key;

                // Check 1: Is ride Pending?
                // Check 2: Is it for ME (Specific Driver ID) OR Broadcast?
                if(ride.status === 'pending' && (ride.driverId === driverData.id || ride.driverId === 'any')) {
                    
                    // Show Popup
                    currentRideRef = ref(db, 'rides/' + rideKey);
                    currentRideData = ride;
                    
                    document.getElementById('req-fare').innerText = ride.fare;
                    
                    // Address Handling
                    document.getElementById('req-drop').innerText = ride.dropAddress || "Drop Location";
                    // For Pickup address, we might need to reverse geocode or use generic
                    document.getElementById('req-pickup').innerText = "Passenger Location (" + ride.vehicle + ")";

                    // Play Sound
                    document.getElementById('ringtone').play();
                    
                    // Show UI
                    document.getElementById('request-ui').classList.add('active');
                }
            });
        }

        // 5. ACCEPT / REJECT
        window.rejectRide = () => {
            document.getElementById('ringtone').pause();
            document.getElementById('request-ui').classList.remove('active');
            currentRideRef = null;
        }

        window.acceptRide = () => {
            document.getElementById('ringtone').pause();
            
            // Firebase Update: Status Accepted
            update(currentRideRef, {
                status: 'accepted',
                driverDetails: {
                    name: driverData.name,
                    plate: driverData.plate,
                    phone: "+91 9876543210"
                }
            });

            // Switch to Active Ride UI
            document.getElementById('request-ui').classList.remove('active');
            document.getElementById('dashboard-ui').classList.add('hidden');
            document.getElementById('active-ride-ui').classList.remove('hidden');
            
            document.getElementById('p-name').innerText = currentRideData.passenger.name;
        }

        // 6. RIDE FLOW (OTP & Navigation)
        window.openGoogleMaps = () => {
            const lat = currentRideData.drop.lat;
            const lng = currentRideData.drop.lng;
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

        window.verifyOTP = () => {
            const input = document.getElementById('otp-input').value;
            // Compare with Firebase OTP (stored in currentRideData)
            if(parseInt(input) === currentRideData.otp) {
                alert("OTP Verified! Start Ride.");
                
                // Update UI
                document.getElementById('otp-section').classList.add('hidden');
                document.getElementById('end-ride-section').classList.remove('hidden');
                
                update(currentRideRef, { status: 'in_progress' });
            } else {
                alert("Wrong OTP! Ask Passenger.");
            }
        }

        window.completeRide = () => {
            if(confirm("Complete Ride and Collect Cash?")) {
                update(currentRideRef, { status: 'completed' });
                alert("Ride Completed! Cash Collected: ₹" + currentRideData.fare);
                location.reload(); // Reset to Dashboard
            }
        }
    </script>
</body>
</html>
