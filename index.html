<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zayra Driver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">

    <div id="screen-login" class="fixed inset-0 bg-yellow-400 flex flex-col justify-center p-8 z-50 text-black">
        <h1 class="text-4xl font-black mb-2">DRIVER LOGIN</h1>
        <p class="mb-8 font-bold opacity-70">Enter the ID from your QR Code</p>
        
        <input type="text" id="login-id" placeholder="Enter ID (e.g. raju01)" class="w-full p-4 text-xl font-bold rounded-xl border-4 border-black mb-4 uppercase">
        <button onclick="startShift()" class="w-full bg-black text-white p-4 rounded-xl font-bold text-xl">START SHIFT</button>
    </div>

    <div id="screen-dash" class="hidden h-screen flex flex-col items-center justify-center p-6 relative">
        <div class="absolute top-4 left-4 bg-gray-800 px-4 py-2 rounded-full text-xs font-bold">
            ID: <span id="disp-id" class="text-yellow-400">---</span>
        </div>
        
        <div class="w-40 h-40 rounded-full border-4 border-green-500 flex items-center justify-center relative">
            <div class="absolute inset-0 bg-green-500 rounded-full opacity-20 animate-ping"></div>
            <i class="ri-radar-line text-6xl text-green-500"></i>
        </div>
        <h2 class="mt-8 text-2xl font-bold">You are Online</h2>
        <p class="text-gray-400">Waiting for Passenger scan...</p>
    </div>

    <div id="screen-request" class="fixed bottom-0 left-0 w-full bg-white text-black rounded-t-3xl p-6 transform translate-y-full transition-transform duration-300 z-40">
        <h2 class="text-green-600 font-bold text-lg mb-2">NEW RIDE REQUEST! ðŸ””</h2>
        <div class="text-4xl font-black mb-4">â‚¹<span id="req-fare">0</span></div>
        
        <div class="space-y-4 mb-8">
            <div class="flex gap-3">
                <i class="ri-map-pin-user-fill text-green-600"></i>
                <div>
                    <div class="text-xs text-gray-500 font-bold">PASSENGER IS AT</div>
                    <div class="font-bold" id="req-pickup">Current Location</div>
                </div>
            </div>
            <div class="flex gap-3">
                <i class="ri-map-pin-fill text-red-600"></i>
                <div>
                    <div class="text-xs text-gray-500 font-bold">GOING TO</div>
                    <div class="font-bold" id="req-drop">---</div>
                </div>
            </div>
        </div>

        <button onclick="acceptRide()" class="w-full bg-green-500 text-white p-4 rounded-xl font-bold text-xl shadow-xl">ACCEPT RIDE</button>
    </div>

    <audio id="sound-alert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAMshTP9HgrB27FuLNP4CZN6VJKPDW8CQ",
            authDomain: "zayra-travels.firebaseapp.com",
            databaseURL: "https://zayra-travels-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "zayra-travels",
            storageBucket: "zayra-travels.firebasestorage.app",
            messagingSenderId: "124448306082",
            appId: "1:124448306082:web:cf5943d8592bc68b9c38fb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myDriverId = "";
        let currentRideKey = "";

        window.startShift = function() {
            const input = document.getElementById('login-id').value.trim();
            if(!input) return alert("ID daalo bhai");
            
            myDriverId = input;
            document.getElementById('disp-id').innerText = myDriverId;
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-dash').classList.remove('hidden');

            // Driver ko Firebase me register karo
            update(ref(db, 'drivers/' + myDriverId), {
                status: 'online',
                last_active: Date.now()
            });

            startListening();
        }

        function startListening() {
            // RIDES table ko suno
            const ridesRef = ref(db, 'rides');
            
            onChildAdded(ridesRef, (snapshot) => {
                const ride = snapshot.val();
                const key = snapshot.key;

                // MAIN LOGIC: Agar ride mere ID ke liye hai aur Pending hai
                if(ride.driverId === myDriverId && ride.status === 'pending') {
                    showRequest(ride, key);
                }
            });
        }

        function showRequest(ride, key) {
            currentRideKey = key;
            document.getElementById('req-fare').innerText = ride.fare;
            document.getElementById('req-drop').innerText = ride.dropAddress;
            
            // Sound Play
            document.getElementById('sound-alert').play();
            
            // Popup Show
            const popup = document.getElementById('screen-request');
            popup.classList.remove('translate-y-full');
        }

        window.acceptRide = function() {
            document.getElementById('sound-alert').pause();
            
            // Firebase Update
            update(ref(db, 'rides/' + currentRideKey), {
                status: 'accepted',
                driverName: 'Raju Bhai', // Real app me profile se aayega
                driverPlate: 'DL 1R 5555'
            });

            alert("Ride Accepted! Go to Pickup.");
            location.reload(); // Demo ke liye reload
        }
    </script>
</body>
</html>
