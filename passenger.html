<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zayra - Production App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; background: #f8f9fa; }
        
        /* Custom Map Tweaks */
        #map { height: 100vh; width: 100%; z-index: 0; }
        .leaflet-routing-container { display: none !important; } /* Hide ugly instructions */
        
        /* Smooth Bottom Sheet Animation */
        .bottom-sheet {
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            transform: translateY(110%);
        }
        .bottom-sheet.active { transform: translateY(0); }

        /* Search Suggestion Styling */
        .leaflet-control-geocoder { display: none; } /* Hide default input, we connect custom input */
        .suggestion-item { padding: 12px; border-bottom: 1px solid #f0f0f0; background: white; cursor: pointer; }
        .suggestion-item:hover { background: #f9f9f9; }
        
        /* Floating Search Bar */
        .search-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 2000; display: none;
        }
        .search-active .search-ui { display: block; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-modal" class="fixed inset-0 bg-white z-[3000] p-6 flex flex-col justify-center hidden">
        <div class="text-center mb-8">
            <img src="https://cdn-icons-png.flaticon.com/512/3082/3082383.png" class="w-20 mx-auto mb-4">
            <h1 class="text-2xl font-bold text-gray-900">Welcome to Zayra</h1>
            <p class="text-gray-500">Enter details to start your ride</p>
        </div>
        <div class="space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Full Name</label>
                <input type="text" id="user-name" class="w-full p-4 bg-gray-100 rounded-xl font-semibold outline-none focus:ring-2 focus:ring-black" placeholder="e.g. Danish Khan">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Phone Number</label>
                <input type="tel" id="user-phone" class="w-full p-4 bg-gray-100 rounded-xl font-semibold outline-none focus:ring-2 focus:ring-black" placeholder="+91 99999 99999">
            </div>
            <button onclick="registerUser()" class="w-full bg-black text-white p-4 rounded-xl font-bold text-lg shadow-lg">Get Started</button>
        </div>
    </div>

    <div id="map"></div>

    <div id="top-bar" class="absolute top-4 left-4 right-4 z-[1000] flex justify-between items-center pointer-events-none">
        <div class="bg-white p-3 rounded-full shadow-lg pointer-events-auto" onclick="toggleSidebar()">
            <i class="ri-menu-2-line text-xl"></i>
        </div>
        <div class="bg-white px-4 py-2 rounded-full shadow-lg font-bold text-sm pointer-events-auto flex items-center gap-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            Online
        </div>
    </div>

    <div id="home-search" class="absolute bottom-0 left-0 w-full bg-white rounded-t-3xl p-6 shadow-2xl z-[1000] transition-all duration-300">
        <h3 class="text-lg font-bold mb-4">Where to?</h3>
        <div class="bg-gray-100 p-4 rounded-xl flex items-center gap-3 cursor-pointer" onclick="activateSearchMode()">
            <i class="ri-search-line text-xl text-gray-500"></i>
            <span class="text-gray-500 font-medium">Search destination...</span>
        </div>
        
        <div class="mt-6">
            <div class="flex items-center gap-4 py-3 border-b border-gray-100">
                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="ri-home-fill"></i></div>
                <div><div class="font-bold text-sm">Home</div><div class="text-xs text-gray-400">Set location</div></div>
            </div>
            <div class="flex items-center gap-4 py-3">
                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="ri-briefcase-fill"></i></div>
                <div><div class="font-bold text-sm">Work</div><div class="text-xs text-gray-400">Set location</div></div>
            </div>
        </div>
    </div>

    <div id="full-search-ui" class="search-ui flex flex-col">
        <div class="p-4 shadow-sm bg-white z-10">
            <div class="flex items-center mb-4">
                <i class="ri-arrow-left-line text-2xl mr-4 cursor-pointer" onclick="deactivateSearchMode()"></i>
                <h2 class="font-bold text-lg">Select Location</h2>
            </div>
            
            <div class="relative pl-8 space-y-4">
                <div class="absolute left-3 top-4 bottom-4 w-0.5 bg-gray-300 border-l border-dashed"></div>
                
                <div class="relative">
                    <div class="absolute -left-8 top-3 w-3 h-3 bg-green-500 rounded-full border-2 border-white shadow"></div>
                    <input type="text" id="pickup-input" class="w-full bg-gray-100 p-3 rounded-lg text-sm font-semibold text-gray-500" value="Current Location" readonly>
                </div>
                
                <div class="relative">
                    <div class="absolute -left-8 top-3 w-3 h-3 bg-red-500 rounded-full border-2 border-white shadow"></div>
                    <input type="text" id="drop-input" class="w-full bg-gray-100 p-3 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-black outline-none" placeholder="Search Drop Location" autofocus oninput="handleTyping(this.value)">
                    <div id="clear-btn" class="absolute right-3 top-3 text-gray-400 hidden" onclick="clearSearch()"><i class="ri-close-circle-fill"></i></div>
                </div>
            </div>
        </div>

        <div id="search-results" class="flex-1 overflow-y-auto bg-gray-50 p-2">
            </div>
    </div>

    <div id="vehicle-sheet" class="bottom-sheet fixed bottom-0 left-0 w-full bg-white rounded-t-3xl shadow-2xl z-[1500] max-h-[85vh] overflow-y-auto">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6"></div>
            
            <div class="flex justify-between items-end mb-6 border-b pb-4">
                <div>
                    <h2 class="text-2xl font-bold" id="dist-display">0 km</h2>
                    <p class="text-gray-500 text-sm" id="time-display">0 mins</p>
                </div>
                <div class="text-right">
                    <div class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-bold">COUPON APPLIED</div>
                </div>
            </div>

            <div class="space-y-3 mb-20">
                <div class="flex items-center justify-between p-4 border-2 border-black bg-yellow-50 rounded-xl cursor-pointer" onclick="selectVehicle('auto', this)">
                    <div class="flex items-center gap-4">
                        <img src="https://cdn-icons-png.flaticon.com/512/2555/2555013.png" class="w-12">
                        <div>
                            <div class="font-bold">Auto</div>
                            <div class="text-xs text-gray-500">Fastest • 3 min</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg">₹<span id="price-auto">0</span></div>
                    </div>
                </div>
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-xl cursor-pointer" onclick="selectVehicle('bike', this)">
                    <div class="flex items-center gap-4">
                        <img src="https://cdn-icons-png.flaticon.com/512/3082/3082383.png" class="w-12">
                        <div>
                            <div class="font-bold">Bike</div>
                            <div class="text-xs text-gray-500">Cheapest • 2 min</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg">₹<span id="price-bike">0</span></div>
                    </div>
                </div>
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-xl cursor-pointer" onclick="selectVehicle('cab', this)">
                    <div class="flex items-center gap-4">
                        <img src="https://cdn-icons-png.flaticon.com/512/2554/2554936.png" class="w-12">
                        <div>
                            <div class="font-bold">Cab</div>
                            <div class="text-xs text-gray-500">AC • 5 min</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg">₹<span id="price-cab">0</span></div>
                    </div>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 w-full p-4 bg-white border-t">
                <button onclick="bookRide()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg">Book Auto</button>
            </div>
        </div>
    </div>

    <div id="status-sheet" class="bottom-sheet fixed bottom-0 left-0 w-full bg-white rounded-t-3xl shadow-2xl z-[1600]">
        <div class="p-6">
            <div class="text-center mb-6">
                <div class="animate-spin w-8 h-8 border-4 border-black border-t-transparent rounded-full mx-auto mb-2"></div>
                <h2 class="font-bold text-xl" id="status-text">Finding nearby drivers...</h2>
                <p class="text-gray-500 text-sm">Connecting you to the best ride</p>
            </div>
            
            <div id="driver-info" class="hidden">
                <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-xl mb-4 border border-gray-200">
                    <div class="w-14 h-14 bg-gray-300 rounded-full overflow-hidden">
                         <img src="https://randomuser.me/api/portraits/men/75.jpg" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-lg" id="d-name">Driver Name</div>
                        <div class="text-sm text-gray-500" id="d-vehicle">White Swift • DL 1R 0000</div>
                    </div>
                    <div class="bg-green-100 text-green-700 px-3 py-1 rounded-lg font-bold text-sm">
                        OTP: <span id="ride-otp">1234</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button class="p-3 border rounded-lg flex flex-col items-center justify-center gap-1 hover:bg-gray-50">
                        <i class="ri-phone-fill text-xl text-blue-600"></i>
                        <span class="text-xs font-bold">Call</span>
                    </button>
                    <button class="p-3 border rounded-lg flex flex-col items-center justify-center gap-1 hover:bg-gray-50">
                        <i class="ri-message-2-fill text-xl text-green-600"></i>
                        <span class="text-xs font-bold">Chat</span>
                    </button>
                </div>
            </div>

            <button onclick="cancelRide()" class="w-full mt-6 bg-red-50 text-red-600 py-3 rounded-xl font-bold">Cancel Ride</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 1. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyAAMshTP9HgrB27FuLNP4CZN6VJKPDW8CQ",
            authDomain: "zayra-travels.firebaseapp.com",
            databaseURL: "https://zayra-travels-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "zayra-travels",
            storageBucket: "zayra-travels.firebasestorage.app",
            messagingSenderId: "124448306082",
            appId: "1:124448306082:web:cf5943d8592bc68b9c38fb"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // GLOBAL STATE
        let map, routingControl;
        let userProfile = JSON.parse(localStorage.getItem('zayra_user')) || null;
        let currentLoc = { lat: 28.6139, lng: 77.2090 };
        let dropLoc = null;
        let currentRideId = null;
        let selectedType = 'auto';

        // 2. INITIALIZATION
        window.onload = () => {
            if (!userProfile) {
                document.getElementById('login-modal').classList.remove('hidden');
            } else {
                initMap();
            }
        };

        window.registerUser = () => {
            const name = document.getElementById('user-name').value;
            const phone = document.getElementById('user-phone').value;
            if(!name || !phone) return alert("Please fill all details");

            userProfile = { name, phone, id: 'u_' + Date.now() };
            localStorage.setItem('zayra_user', JSON.stringify(userProfile));
            
            // Save to Firebase
            set(ref(db, 'users/' + userProfile.id), userProfile);
            
            document.getElementById('login-modal').classList.add('hidden');
            initMap();
        }

        // 3. MAP & LOCATION
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([currentLoc.lat, currentLoc.lng], 13);
            
            // Clean Google-like Map Tiles (CartoDB)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: ''
            }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    currentLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setView(currentLoc, 16);
                    
                    // User Marker (Blue Dot)
                    const userIcon = L.divIcon({
                        className: 'user-marker',
                        html: '<div style="width:16px;height:16px;background:#3B82F6;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>'
                    });
                    L.marker(currentLoc, {icon: userIcon}).addTo(map);
                    
                    // Update Pickup Input Text
                    reverseGeocode(currentLoc.lat, currentLoc.lng);
                });
            }
        }

        function reverseGeocode(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('pickup-input').value = data.display_name.split(',')[0]; // Short address
                });
        }

        // 4. SEARCH LOGIC (The Professional Part)
        // We use Leaflet Geocoder but render results manually to match Rapido UI
        
        let geocoder = L.Control.Geocoder.nominatim();
        let debounceTimer;

        window.activateSearchMode = () => {
            document.getElementById('full-search-ui').classList.add('search-active');
            document.getElementById('drop-input').focus();
        };

        window.deactivateSearchMode = () => {
            document.getElementById('full-search-ui').classList.remove('search-active');
        };

        window.handleTyping = (query) => {
            clearTimeout(debounceTimer);
            if(query.length < 3) return;

            debounceTimer = setTimeout(() => {
                geocoder.geocode(query, (results) => {
                    const list = document.getElementById('search-results');
                    list.innerHTML = ''; // Clear previous

                    results.forEach(res => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-4 p-4 border-b border-gray-100 bg-white cursor-pointer hover:bg-gray-50';
                        div.innerHTML = `
                            <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 flex-shrink-0">
                                <i class="ri-map-pin-line"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm text-gray-800">${res.name.split(',')[0]}</div>
                                <div class="text-xs text-gray-400 truncate w-64">${res.name}</div>
                            </div>
                        `;
                        div.onclick = () => selectDestination(res);
                        list.appendChild(div);
                    });
                });
            }, 300); // 300ms debounce
        };

        function selectDestination(res) {
            dropLoc = res.center; // Leaflet LatLng object
            document.getElementById('drop-input').value = res.name;
            deactivateSearchMode();
            
            // Draw Route
            drawRoute();
        }

        function drawRoute() {
            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(currentLoc.lat, currentLoc.lng),
                    dropLoc
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                draggableWaypoints: false,
                lineOptions: { styles: [{ color: 'black', opacity: 0.8, weight: 4 }] },
                createMarker: function(i, wp, nWps) {
                    if (i === 0) return null; // No marker for start (already have blue dot)
                    return L.marker(wp.latLng, {
                        icon: L.icon({
                            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3082/3082383.png', // Flag or Pin
                            iconSize: [30, 30]
                        })
                    });
                }
            }).addTo(map);

            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                // Update UI with Data
                const km = (summary.totalDistance / 1000).toFixed(1);
                const mins = Math.round(summary.totalTime / 60);
                
                document.getElementById('dist-display').innerText = `${km} km`;
                document.getElementById('time-display').innerText = `${mins} mins`;

                // Calculate Prices
                calculatePrices(km);
                
                // Show Vehicle Sheet
                document.getElementById('home-search').classList.add('hidden');
                document.getElementById('vehicle-sheet').classList.add('active');
            });
        }

        function calculatePrices(km) {
            // Logic: Base + (Rate * Km)
            document.getElementById('price-bike').innerText = Math.round(20 + (8 * km));
            document.getElementById('price-auto').innerText = Math.round(30 + (12 * km));
            document.getElementById('price-cab').innerText = Math.round(50 + (15 * km));
        }

        // 5. BOOKING & DATABASE INTERACTION (The End-to-End Logic)
        
        window.selectVehicle = (type, el) => {
            selectedType = type;
            // Visual feedback logic can be added here
            document.querySelectorAll('#vehicle-sheet .border-black').forEach(e => {
                e.classList.remove('border-black', 'bg-yellow-50');
                e.classList.add('border-gray-200');
            });
            el.classList.add('border-black', 'bg-yellow-50');
            el.classList.remove('border-gray-200');
        };

        window.bookRide = () => {
            // 1. UI Updates
            document.getElementById('vehicle-sheet').classList.remove('active');
            document.getElementById('status-sheet').classList.add('active');

            // 2. Get QR Data (If available from URL, else broad search)
            const params = new URLSearchParams(window.location.search);
            const specificDriver = params.get('driverId') || 'any';

            // 3. Create Ride in Firebase
            const rideRef = push(ref(db, 'rides'));
            currentRideId = rideRef.key;

            const rideData = {
                rideId: currentRideId,
                passenger: {
                    name: userProfile.name,
                    phone: userProfile.phone,
                    id: userProfile.id
                },
                driverId: specificDriver, // 'any' or specific ID
                status: 'pending',
                pickup: currentLoc,
                drop: dropLoc,
                dropAddress: document.getElementById('drop-input').value,
                vehicleType: selectedType,
                fare: document.getElementById(`price-${selectedType}`).innerText,
                timestamp: Date.now(),
                otp: Math.floor(1000 + Math.random() * 9000)
            };

            set(rideRef, rideData);
            document.getElementById('ride-otp').innerText = rideData.otp;

            // 4. Listen for Driver Response
            listenToRide(currentRideId);
        };

        function listenToRide(rideId) {
            const rideStatusRef = ref(db, `rides/${rideId}`);
            onValue(rideStatusRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                if (data.status === 'accepted') {
                    // Driver Accepted!
                    document.getElementById('status-text').innerText = "Driver is arriving!";
                    document.getElementById('status-text').classList.add('text-green-600');
                    
                    // Show Driver Details
                    document.getElementById('driver-info').classList.remove('hidden');
                    
                    if (data.driverDetails) {
                        document.getElementById('d-name').innerText = data.driverDetails.name;
                        document.getElementById('d-vehicle').innerText = data.driverDetails.vehicle || "Vehicle Info";
                    }
                }
            });
        }

        window.cancelRide = () => {
            if(confirm("Are you sure?")) {
                if(currentRideId) remove(ref(db, `rides/${currentRideId}`));
                location.reload();
            }
        };

        // EXPOSE TO WINDOW
        window.initMap = initMap;
    </script>
</body>
</html>
