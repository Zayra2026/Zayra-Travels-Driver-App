<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zayra Passenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100">

    <div id="map" class="h-screen w-full z-0"></div>

    <div id="ui-normal" class="fixed bottom-0 w-full bg-white p-6 rounded-t-3xl shadow-2xl z-10 hidden">
        <h2 class="text-xl font-bold mb-4">Where to?</h2>
        <input type="text" placeholder="Search destination" class="w-full p-4 bg-gray-100 rounded-xl mb-4">
        <p class="text-xs text-red-500">Scan a QR code on the vehicle to book instantly.</p>
    </div>

    <div id="ui-qr" class="fixed bottom-0 w-full bg-white p-6 rounded-t-3xl shadow-2xl z-20 hidden">
        <div class="flex items-center gap-4 mb-6 bg-yellow-50 p-4 rounded-xl border border-yellow-200">
            <div class="bg-black text-white px-3 py-1 rounded text-xs font-bold uppercase">AUTO</div>
            <div>
                <div class="font-bold text-lg" id="v-plate">DL 1R ----</div>
                <div class="text-xs text-green-600 font-bold">● Driver Nearby</div>
            </div>
        </div>

        <h3 class="font-bold text-gray-500 text-xs uppercase mb-2">Drop Location</h3>
        <input type="text" id="drop-input" class="w-full p-4 bg-gray-100 rounded-xl font-bold border-2 focus:border-black outline-none mb-4" placeholder="Enter Drop Location (e.g. Metro Station)">
        
        <div class="flex justify-between items-center mb-6">
            <div class="font-bold text-3xl">₹<span id="est-fare">50</span></div>
            <div class="text-xs text-gray-400">Base Fare Estimate</div>
        </div>

        <button onclick="bookDirectRide()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg">BOOK THIS RIDE</button>
    </div>

    <div id="ui-waiting" class="fixed inset-0 bg-white z-50 hidden flex flex-col items-center justify-center p-8 text-center">
        <div class="w-20 h-20 border-4 border-gray-200 border-t-yellow-400 rounded-full animate-spin mb-6"></div>
        <h2 class="text-2xl font-bold mb-2">Requesting Driver...</h2>
        <p class="text-gray-500">Sending alert to vehicle <span id="wait-plate" class="font-bold">---</span></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAMshTP9HgrB27FuLNP4CZN6VJKPDW8CQ",
            authDomain: "zayra-travels.firebaseapp.com",
            databaseURL: "https://zayra-travels-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "zayra-travels",
            storageBucket: "zayra-travels.firebasestorage.app",
            messagingSenderId: "124448306082",
            appId: "1:124448306082:web:cf5943d8592bc68b9c38fb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let targetDriverId = null;
        let myLoc = { lat: 28.61, lng: 77.20 };

        window.onload = function() {
            initMap();
            checkQR();
        }

        function initMap() {
            const map = L.map('map', { zoomControl: false }).setView([28.61, 77.20], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(map);
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    myLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setView(myLoc, 15);
                    L.marker(myLoc).addTo(map);
                });
            }
        }

        // --- MAIN LOGIC: URL PARAMS CHECK ---
        function checkQR() {
            const params = new URLSearchParams(window.location.search);
            const dId = params.get('d_id'); // Admin ne yahi naam rakha tha
            const plate = params.get('plate');

            if(dId) {
                // QR MODE ACTIVE
                targetDriverId = dId;
                document.getElementById('v-plate').innerText = plate || "Unknown Vehicle";
                document.getElementById('ui-qr').classList.remove('hidden');
                document.getElementById('wait-plate').innerText = plate;
            } else {
                // NORMAL MODE
                document.getElementById('ui-normal').classList.remove('hidden');
            }
        }

        window.bookDirectRide = function() {
            const drop = document.getElementById('drop-input').value;
            if(!drop) return alert("Drop location to daalo!");

            // 1. Show Waiting UI
            document.getElementById('ui-qr').classList.add('hidden');
            document.getElementById('ui-waiting').classList.remove('hidden');

            // 2. Push to Firebase (Exactly matching Driver Listener)
            const newRide = push(ref(db, 'rides'));
            set(newRide, {
                driverId: targetDriverId, // Yahi ID driver ke pass honi chahiye
                passenger: "Guest User",
                pickup: myLoc,
                dropAddress: drop,
                fare: document.getElementById('est-fare').innerText,
                status: 'pending',
                timestamp: Date.now()
            });

            // 3. Listen for Accept
            onValue(ref(db, 'rides/' + newRide.key), (snap) => {
                const data = snap.val();
                if(data && data.status === 'accepted') {
                    alert("✅ DRIVER ACCEPTED! Ride Started.");
                    document.getElementById('ui-waiting').innerHTML = "<h1 class='text-3xl font-bold text-green-600'>RIDE CONFIRMED</h1>";
                }
            });
        }
    </script>
</body>
</html>
